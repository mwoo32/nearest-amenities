<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nearest Washroom / Drinking Fountain</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    body { margin:0; padding:0; }
    #map { height: 100vh; }
    .controls {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 8px;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        font-family: sans-serif;
    }
    button { margin-left: 5px; }
</style>
</head>
<body>

<div class="controls">
    <select id="amenitySelect">
        <option value="toilets">ðŸš» Public Washroom</option>
        <option value="drinking_water">ðŸ’§ Drinking Fountain</option>
    </select>
    <button id="refreshBtn">Refresh</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, userMarker, amenityMarkers = [], routeLine;
const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

function initMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    userMarker = L.marker([lat, lon], { icon: redIcon }).addTo(map).bindPopup("ðŸ“ You are here");
    loadAmenities(lat, lon);
}

function loadAmenities(lat, lon) {
    // Clear previous markers/route
    amenityMarkers.forEach(m => map.removeLayer(m));
    amenityMarkers = [];
    if (routeLine) { map.removeLayer(routeLine); routeLine = null; }

    const amenityType = document.getElementById("amenitySelect").value;
    const query = `
        [out:json];
        node(around:2000,${lat},${lon})[amenity=${amenityType}];
        out;
    `;
    fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    })
    .then(res => res.json())
    .then(data => {
        if (!data.elements.length) {
            alert("No amenities found nearby.");
            return;
        }
        let nearest = null, nearestDist = Infinity;
        data.elements.forEach(el => {
            const dist = map.distance([lat, lon], [el.lat, el.lon]);
            if (dist < nearestDist) {
                nearestDist = dist;
                nearest = el;
            }
            const marker = L.marker([el.lat, el.lon]).addTo(map);
            marker.bindPopup(`${amenityType === 'toilets' ? 'ðŸš» Public Washroom' : 'ðŸ’§ Drinking Fountain'}`);
            amenityMarkers.push(marker);
        });
        if (nearest) {
            drawPath(lat, lon, nearest.lat, nearest.lon);
        }
    })
    .catch(err => console.error(err));
}

function drawPath(startLat, startLon, endLat, endLon) {
    const url = `https://router.project-osrm.org/route/v1/walking/${startLon},${startLat};${endLon},${endLat}?overview=full&geometries=geojson`;
    fetch(url)
        .then(res => res.json())
        .then(data => {
            const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            routeLine = L.polyline(coords, { color: 'blue', weight: 4 }).addTo(map);
            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        })
        .catch(err => console.error(err));
}

// Geolocation and initialization
function locateAndInit() {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        if (!map) {
            initMap(lat, lon);
        } else {
            map.setView([lat, lon], 15);
            userMarker.setLatLng([lat, lon]);
            loadAmenities(lat, lon);
        }
    }, () => {
        alert("Could not get your location.");
    });
}

document.getElementById("refreshBtn").addEventListener("click", locateAndInit);
document.getElementById("amenitySelect").addEventListener("change", locateAndInit);

// Start the app
locateAndInit();
</script>

</body>
</html>
