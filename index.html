<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nearest Amenities</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { height:100%; }
  #controls {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 8px;
    font-size: 14px;
  }
  #refreshBtn {
    background: #2196f3;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 5px;
    width: 100%;
  }
  label { display: block; margin-top: 5px; }
  /* Hide routing panel */
  .leaflet-routing-container {
    display: none !important;
  }
</style>
</head>
<body>
<div id="controls">
  <label>
    Amenity:
    <select id="amenitySelect">
      <option value="toilets">Public Washrooms</option>
      <option value="drinking_water">Drinking Fountains</option>
    </select>
  </label>
  <label>
    Search Radius: <span id="radiusValue">5000</span> m
    <input type="range" id="radiusSlider" min="500" max="10000" step="500" value="5000">
  </label>
  <button id="refreshBtn">?? Refresh</button>
</div>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
let map, userLat, userLon, radiusCircle, routeControl;

// Red icon for user location
const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
              Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function initMap() {
    if (map) {
        map.remove();
    }
    map = L.map('map').setView([0,0], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
}

async function loadAmenities() {
    const amenity = document.getElementById("amenitySelect").value;
    const radius = parseInt(document.getElementById("radiusSlider").value);

    if (radiusCircle) {
        map.removeLayer(radiusCircle);
    }
    if (routeControl) {
        map.removeControl(routeControl);
    }

    navigator.geolocation.getCurrentPosition(async pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;

        initMap();

        L.marker([userLat, userLon], { icon: redIcon })
            .addTo(map)
            .bindPopup("?? You are here");

        // Draw radius circle
        radiusCircle = L.circle([userLat, userLon], {
            radius: radius,
            color: "#2196f3",
            fillColor: "#2196f3",
            fillOpacity: 0.1
        }).addTo(map);

        const query = `
            [out:json];
            node["amenity"="${amenity}"](around:${radius},${userLat},${userLon});
            out;
        `;

        const response = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: query
        });
        const data = await response.json();

        if (!data.elements.length) {
            alert(`No ${amenity.replace("_", " ")} found within ${radius}m.`);
            return;
        }

        const nearest = data.elements
            .map(w => ({
                lat: w.lat,
                lon: w.lon,
                distance: getDistance(userLat, userLon, w.lat, w.lon)
            }))
            .sort((a, b) => a.distance - b.distance)[0];

        data.elements.forEach(w => {
            L.marker([w.lat, w.lon])
                .addTo(map)
                .bindPopup(`${amenity.replace("_"," ")}<br>${getDistance(userLat, userLon, w.lat, w.lon).toFixed(2)} km away`);
        });

        // Draw walking route without showing instructions
        routeControl = L.Routing.control({
            waypoints: [
                L.latLng(userLat, userLon),
                L.latLng(nearest.lat, nearest.lon)
            ],
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            draggableWaypoints: false,
            createMarker: () => null
        }).addTo(map);

    }, err => {
        alert("Unable to get your location.");
    });
}

// Refresh button
document.getElementById("refreshBtn").addEventListener("click", loadAmenities);

// Auto refresh when changing amenity type or radius
document.getElementById("amenitySelect").addEventListener("change", loadAmenities);
document.getElementById("radiusSlider").addEventListener("input", e => {
    document.getElementById("radiusValue").textContent = e.target.value;
    loadAmenities();
});

loadAmenities();
</script>
</body>
</html>
